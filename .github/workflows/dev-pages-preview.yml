name: Dev Preview (GitHub Pages)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag, or SHA to preview"
        required: true
        default: "dev"
        type: string
      site:
        description: "Site to preview on GitHub Pages"
        required: true
        default: "megameal"
        type: choice
        options:
          - megameal
          - travel
          - dndiy
          - temporal

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: github-pages-dev-preview
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.14.4"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout selected ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Build selected site for repo Pages path
        env:
          PREVIEW_SITE: ${{ inputs.site }}
        run: |
          set -euo pipefail
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          PREVIEW_SITE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io"
          PREVIEW_BASE="/${REPO_NAME}/"

          rm -rf preview-dist
          case "${PREVIEW_SITE}" in
            megameal)
              SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${PREVIEW_BASE}" pnpm build:megameal
              cp -a apps/megameal/dist preview-dist
              ;;
            travel)
              SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${PREVIEW_BASE}" pnpm build:travel
              cp -a apps/travel/dist preview-dist
              ;;
            dndiy)
              SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${PREVIEW_BASE}" pnpm build:dndiy
              cp -a DNDIY.github.io/dist preview-dist
              ;;
            temporal)
              SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${PREVIEW_BASE}" pnpm build:temporal
              cp -a Temporal-Flow/dist preview-dist
              ;;
            *)
              echo "Unsupported site: ${PREVIEW_SITE}"
              exit 1
              ;;
          esac

          touch preview-dist/.nojekyll
          printf "site=%s\nref=%s\nsha=%s\n" "${PREVIEW_SITE}" "${{ inputs.ref }}" "${GITHUB_SHA}" > preview-dist/preview-meta.txt

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: preview-dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
