name: Dev Preview (GitHub Pages)

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag, or SHA to preview"
        required: true
        default: "dev"
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: github-pages-dev-preview
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9.14.4"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout selected ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install workspace dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all sites into subfolders
        run: |
          set -euo pipefail
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          PREVIEW_SITE_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io"
          BASE="/${REPO_NAME}"

          rm -rf preview-dist
          mkdir -p preview-dist

          SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${BASE}/megameal/" pnpm build:megameal
          cp -a apps/megameal/dist preview-dist/megameal

          SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${BASE}/travel/" pnpm build:travel
          cp -a apps/travel/dist preview-dist/travel

          SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${BASE}/dndiy/" pnpm build:dndiy
          cp -a DNDIY.github.io/dist preview-dist/dndiy

          SITE_URL="${PREVIEW_SITE_URL}" SITE_BASE="${BASE}/temporal/" pnpm build:temporal
          cp -a Temporal-Flow/dist preview-dist/temporal

          touch preview-dist/.nojekyll

          cat > preview-dist/index.html <<'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head><meta charset="utf-8"><title>Merkin Dev Preview</title>
          <style>body{font-family:sans-serif;max-width:600px;margin:4rem auto;padding:0 1rem}a{display:block;margin:1rem 0;font-size:1.2rem}</style>
          </head>
          <body>
          <h1>Merkin Dev Preview</h1>
          <a href="megameal/">MEGA MEAL SAGA</a>
          <a href="travel/">Trail Log (Travel)</a>
          <a href="dndiy/">DNDIY</a>
          <a href="temporal/">Temporal Flow</a>
          </body>
          </html>
          HTMLEOF

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: preview-dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
