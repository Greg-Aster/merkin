---
// src/components/widget/FactsWidget.astro
import InfoCard from './InfoCard.astro';
import type { TimelineFact } from '../../config/timelineFacts';
import { megaMealUniverseFacts } from '../../config/timelineFacts';

export interface Props {
    footerText?: string;
}

const { footerText = "Un-Sponsored Content." } = Astro.props;

const cardId = "sidebar-info-card";

// Select a random fact to display initially
const initialFact: TimelineFact | null = megaMealUniverseFacts.length > 0
    ? megaMealUniverseFacts[Math.floor(Math.random() * megaMealUniverseFacts.length)]
    : null;
---

<div class="facts-widget-container card-base p-4">
    <!-- <h2 class="text-lg font-bold text-90 mb-2">Did you know?</h2> -->
    
    {initialFact && (
        <InfoCard
            cardId={cardId}
            initialFact={initialFact}
            initialIsVisible={true}
        />
    )}
    
    <p class="text-xs text-50 mt-3 text-center">
        {footerText}
    </p>
</div>

<script define:vars={{ cardId, facts: megaMealUniverseFacts }}>
    if (facts.length > 0) {
        const widgetContainer = document.querySelector('.facts-widget-container');

        const showNextFact = () => {
            const randomFact = facts[Math.floor(Math.random() * facts.length)];
            
            document.body.dispatchEvent(new CustomEvent('displayStarInfoCard', {
                detail: {
                    fact: randomFact,
                    cardIdToTarget: cardId
                }
            }));
        };

        // Listen for the close event from the card
        widgetContainer?.addEventListener('infocard:closed', () => {
            // Show a new fact immediately when the current one is closed
            showNextFact();
        });

        // Continue rotating facts periodically
        setInterval(showNextFact, 20000 + Math.random() * 10000);
    }
</script>