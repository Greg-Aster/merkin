image: node:22

workflow:
  rules:
    # GitLab is production-only to conserve CI minutes.
    - if: '$CI_COMMIT_BRANCH == "main"'
    # Allow manual web-triggered production deploy pipelines on main.
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main"'
    - when: never

stages:
  - deploy

variables:
  PNPM_VERSION: "9.14.4"

default:
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store/
    policy: pull-push
  before_script:
    - npm install -g pnpm@${PNPM_VERSION} --silent
    - pnpm config set store-dir .pnpm-store
    - pnpm install --frozen-lockfile

# Flow:
# - Preview deploys run on GitHub Pages workflow only.
# - GitLab CI runs production deploys from main only.
# - Main branch: auto production deploys.

# Temporal-Flow -> temporalflow.org
preview-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "web"'
      when: manual
      allow_failure: true
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "temporal")'
      when: manual
      allow_failure: true

promote-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml

deploy-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "temporal")'
      when: manual
      allow_failure: true

# DNDIY -> dndiy.org
preview-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "web"'
      when: manual
      allow_failure: true
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "dndiy")'
      when: manual
      allow_failure: true

promote-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml

deploy-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "dndiy")'
      when: manual
      allow_failure: true

# MEGAMEAL -> megameal.org (now a workspace app at apps/megameal/)
preview-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "web"'
      when: manual
      allow_failure: true
      changes:
        - apps/megameal/**/*
        - MEGAMEAL/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "megameal")'
      when: manual
      allow_failure: true

promote-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - apps/megameal/**/*
        - MEGAMEAL/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml

deploy-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - apps/megameal/**/*
        - MEGAMEAL/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "megameal")'
      when: manual
      allow_failure: true

# Travel -> travel.dndiy.org
preview-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "web"'
      when: manual
      allow_failure: true
      changes:
        - apps/travel/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "travel")'
      when: manual
      allow_failure: true

promote-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - apps/travel/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml

deploy-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - apps/travel/**/*
        - packages/**/*
        - pnpm-lock.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "travel")'
      when: manual
      allow_failure: true
