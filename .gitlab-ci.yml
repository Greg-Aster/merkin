image: node:22

stages:
  - deploy

default:
  before_script:
    - npm install -g pnpm@9.14.4 --silent
    - pnpm install --frozen-lockfile

# Flow:
# - Non-main branches: auto preview deploys to branch-named previews.
# - Non-main branches: manual "promote-*" jobs publish that exact commit to production.
# - Main branch: auto production deploys.

# Temporal-Flow -> temporalflow.org
preview-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "temporal")'
      when: manual
      allow_failure: true

promote-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml

deploy-temporal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:temporal
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - Temporal-Flow/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "temporal")'
      when: manual
      allow_failure: true

# DNDIY -> dndiy.org
preview-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "dndiy")'
      when: manual
      allow_failure: true

promote-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml

deploy-dndiy:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:dndiy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - DNDIY.github.io/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "dndiy")'
      when: manual
      allow_failure: true

# MEGAMEAL -> megameal.org
preview-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - MEGAMEAL/**/*
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "megameal")'
      when: manual
      allow_failure: true

promote-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - MEGAMEAL/**/*
        - .gitlab-ci.yml

deploy-megameal:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:megameal
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - MEGAMEAL/**/*
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "megameal")'
      when: manual
      allow_failure: true

# Travel -> travel.dndiy.org
preview-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="$CI_COMMIT_REF_SLUG" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - apps/travel/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "travel")'
      when: manual
      allow_failure: true

promote-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "main"'
      when: manual
      changes:
        - apps/travel/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml

deploy-travel:
  stage: deploy
  script:
    - DEPLOY_BRANCH="main" pnpm deploy:travel
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "web"'
      changes:
        - apps/travel/**/*
        - packages/**/*
        - package.json
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main" && ($DEPLOY_SITE == "all" || $DEPLOY_SITE == "travel")'
      when: manual
      allow_failure: true
